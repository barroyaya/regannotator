{% extends 'base.html' %}

{% block title %}Assigner une T√¢che - RegAnnotator{% endblock %}
{% block page_title %}Assigner une T√¢che Expert{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="stat-card">
            <h5 class="mb-4">Assigner une Nouvelle T√¢che</h5>
            
            <form method="post">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Expert <span class="text-danger">*</span></label>
                            <select class="form-select" name="expert_id" required id="expert-select">
                                <option value="">Choisir un expert...</option>
                                {% for expert in experts %}
                                    <option value="{{ expert.id }}" 
                                            data-level="{{ expert.expertise_level }}"
                                            data-specializations="{{ expert.specializations|join:',' }}"
                                            {% if request.GET.expert_id == expert.id|stringformat:"s" %}selected{% endif %}>
                                        {{ expert.user.get_full_name|default:expert.user.username }} 
                                        ({{ expert.get_expertise_level_display }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Type de t√¢che <span class="text-danger">*</span></label>
                            <select class="form-select" name="task_type" required id="task-type">
                                <option value="">Choisir...</option>
                                {% for value, label in task_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Priorit√©</label>
                            <select class="form-select" name="priority">
                                {% for value, label in priority_choices %}
                                    <option value="{{ value }}" {% if value == 'normal' %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Document associ√© (optionnel)</label>
                            <select class="form-select" name="document_id" id="document-select">
                                <option value="">Aucun document sp√©cifique</option>
                                {% for document in documents %}
                                    <option value="{{ document.id }}" data-source="{{ document.source.acronym }}">
                                        {{ document.title|truncatechars:60 }} ({{ document.source.acronym }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Titre de la t√¢che <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="title" required
                                   placeholder="ex: Validation annotations document EMA-2024-001">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" name="description" rows="4" required
                                      placeholder="D√©crivez en d√©tail ce que l'expert doit faire..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Date d'√©ch√©ance</label>
                                    <input type="date" class="form-control" name="due_date" 
                                           min="{{ today|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Temps estim√© (heures)</label>
                                    <input type="number" class="form-control" name="estimated_hours" 
                                           min="0.5" step="0.5" placeholder="ex: 2.5">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Aper√ßu expert s√©lectionn√© -->
                <div class="alert alert-info" id="expert-preview" style="display: none;">
                    <h6><i class="fas fa-user-md"></i> Profil de l'Expert S√©lectionn√©</h6>
                    <div id="expert-info"></div>
                </div>
                
                <!-- Suggestions de t√¢ches selon le type -->
                <div class="card" id="task-suggestions" style="display: none;">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Suggestions pour ce Type de T√¢che</h6>
                    </div>
                    <div class="card-body" id="suggestions-content">
                        <!-- Contenu dynamique -->
                    </div>
                </div>
                
                <hr>
                <div class="d-flex justify-content-between">
                    <a href="{% url 'experts:dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Annuler
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-tasks"></i> Assigner la T√¢che
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Templates de suggestions -->
<div class="row justify-content-center mt-4">
    <div class="col-md-10">
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <h6 class="mb-3">üí° Types de T√¢ches Disponibles</h6>
                    <div class="accordion" id="taskTypesAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#validation-info">
                                    Validation d'annotations
                                </button>
                            </h2>
                            <div id="validation-info" class="accordion-collapse collapse">
                                <div class="accordion-body small">
                                    <strong>Objectif :</strong> Valider ou corriger les annotations automatiques<br>
                                    <strong>Dur√©e typique :</strong> 1-3 heures<br>
                                    <strong>Expertise requise :</strong> Confirm√© minimum
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#review-info">
                                    R√©vision de document
                                </button>
                            </h2>
                            <div id="review-info" class="accordion-collapse collapse">
                                <div class="accordion-body small">
                                    <strong>Objectif :</strong> R√©viser un document dans son ensemble<br>
                                    <strong>Dur√©e typique :</strong> 2-8 heures<br>
                                    <strong>Expertise requise :</strong> Senior minimum
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#training-info">
                                    Formation de mod√®le
                                </button>
                            </h2>
                            <div id="training-info" class="accordion-collapse collapse">
                                <div class="accordion-body small">
                                    <strong>Objectif :</strong> Participer √† l'am√©lioration du mod√®le IA<br>
                                    <strong>Dur√©e typique :</strong> 0.5-2 heures<br>
                                    <strong>Expertise requise :</strong> Expert recommand√©
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#quality-info">
                                    Contr√¥le qualit√©
                                </button>
                            </h2>
                            <div id="quality-info" class="accordion-collapse collapse">
                                <div class="accordion-body small">
                                    <strong>Objectif :</strong> Audit qualit√© d'un processus ou r√©sultat<br>
                                    <strong>Dur√©e typique :</strong> 1-4 heures<br>
                                    <strong>Expertise requise :</strong> Senior minimum
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="stat-card">
                    <h6 class="mb-3">üìà Recommandations d'Assignation</h6>
                    <div class="alert alert-success">
                        <strong>Bonnes Pratiques :</strong>
                        <ul class="mb-0 mt-2">
                            <li>Adapter la complexit√© au niveau d'expertise</li>
                            <li>D√©finir des √©ch√©ances r√©alistes</li>
                            <li>Fournir un contexte d√©taill√©</li>
                            <li>Consid√©rer la charge de travail actuelle</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>Niveaux Recommand√©s :</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>Junior :</strong> Validation simple, formation</li>
                            <li><strong>Confirm√© :</strong> Validation complexe, r√©vision partielle</li>
                            <li><strong>Senior :</strong> R√©vision compl√®te, contr√¥le qualit√©</li>
                            <li><strong>Expert :</strong> Toutes t√¢ches, formation mod√®le</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Aper√ßu de l'expert s√©lectionn√©
document.getElementById('expert-select').addEventListener('change', function() {
    const selectedOption = this.selectedOptions[0];
    const preview = document.getElementById('expert-preview');
    const expertInfo = document.getElementById('expert-info');
    
    if (selectedOption.value) {
        const expertName = selectedOption.textContent.split(' (')[0];
        const level = selectedOption.getAttribute('data-level');
        const specializations = selectedOption.getAttribute('data-specializations');
        
        expertInfo.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <strong>Nom:</strong> ${expertName}<br>
                    <strong>Niveau:</strong> ${level}
                </div>
                <div class="col-md-8">
                    <strong>Sp√©cialisations:</strong> ${specializations || 'Aucune d√©finie'}<br>
                    <strong>Disponibilit√©:</strong> <span class="badge bg-success">Disponible</span>
                </div>
            </div>
        `;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

// Suggestions selon le type de t√¢che
document.getElementById('task-type').addEventListener('change', function() {
    const taskType = this.value;
    const suggestions = document.getElementById('task-suggestions');
    const content = document.getElementById('suggestions-content');
    
    const suggestionTexts = {
        'validation': {
            title: 'Suggestions pour la Validation d\'Annotations',
            items: [
                'V√©rifier la coh√©rence des entit√©s VARIATION_CODE',
                'Valider les r√©f√©rences l√©gales cit√©es',
                'Contr√¥ler la pr√©cision des d√©lais mentionn√©s',
                'S\'assurer de la compl√©tude des conditions requises'
            ]
        },
        'review': {
            title: 'Suggestions pour la R√©vision de Document',
            items: [
                'Analyser la structure g√©n√©rale du document',
                'V√©rifier la conformit√© aux guidelines',
                'Identifier les sections manquantes',
                'Contr√¥ler la terminologie r√©glementaire'
            ]
        },
        'training': {
            title: 'Suggestions pour la Formation de Mod√®le',
            items: [
                'Fournir des exemples d\'annotations correctes',
                'Identifier les patterns r√©currents',
                'Corriger les erreurs typiques du mod√®le',
                'D√©finir de nouvelles r√®gles d\'annotation'
            ]
        },
        'quality_check': {
            title: 'Suggestions pour le Contr√¥le Qualit√©',
            items: [
                'Audit des processus d\'annotation',
                'V√©rification de la coh√©rence inter-experts',
                'Contr√¥le de la conformit√© r√©glementaire',
                'Validation des m√©triques de performance'
            ]
        }
    };
    
    if (taskType && suggestionTexts[taskType]) {
        const suggestion = suggestionTexts[taskType];
        content.innerHTML = `
            <h6>${suggestion.title}</h6>
            <ul class="mb-0">
                ${suggestion.items.map(item => `<li>${item}</li>`).join('')}
            </ul>
        `;
        suggestions.style.display = 'block';
    } else {
        suggestions.style.display = 'none';
    }
});

// Auto-remplissage du titre selon le type
document.getElementById('task-type').addEventListener('change', function() {
    const taskType = this.value;
    const titleField = document.querySelector('input[name="title"]');
    const documentSelect = document.getElementById('document-select');
    
    if (taskType && !titleField.value) {
        const titles = {
            'validation': 'Validation des annotations automatiques',
            'review': 'R√©vision experte du document',
            'training': 'Formation et am√©lioration du mod√®le IA',
            'quality_check': 'Contr√¥le qualit√© du processus d\'annotation'
        };
        
        let title = titles[taskType] || '';
        
        // Ajouter le document si s√©lectionn√©
        if (documentSelect.value) {
            const documentText = documentSelect.selectedOptions[0].textContent;
            title += ` - ${documentText.split('(')[0].trim()}`;
        }
        
        titleField.value = title;
    }
});

// Mettre √† jour le titre quand le document change
document.getElementById('document-select').addEventListener('change', function() {
    const taskType = document.getElementById('task-type').value;
    const titleField = document.querySelector('input[name="title"]');
    
    // D√©clencher la mise √† jour du titre
    if (taskType) {
        document.getElementById('task-type').dispatchEvent(new Event('change'));
    }
});

// Validation du formulaire
document.querySelector('form').addEventListener('submit', function(e) {
    const expertSelect = document.getElementById('expert-select');
    const taskType = document.getElementById('task-type');
    const title = document.querySelector('input[name="title"]');
    const description = document.querySelector('textarea[name="description"]');
    
    if (!expertSelect.value) {
        e.preventDefault();
        alert('Veuillez s√©lectionner un expert.');
        expertSelect.focus();
        return;
    }
    
    if (!taskType.value) {
        e.preventDefault();
        alert('Veuillez s√©lectionner un type de t√¢che.');
        taskType.focus();
        return;
    }
    
    if (title.value.trim().length < 5) {
        e.preventDefault();
        alert('Le titre doit contenir au moins 5 caract√®res.');
        title.focus();
        return;
    }
    
    if (description.value.trim().length < 10) {
        e.preventDefault();
        alert('La description doit contenir au moins 10 caract√®res.');
        description.focus();
        return;
    }
});
</script>
{% endblock %}